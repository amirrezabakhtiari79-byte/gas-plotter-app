name: Build Android APK (Final Version)

on:
push:
branches:
- main
- master
workflow_dispatch:

jobs:
build-android:
name: Build APK using official Kivy Docker image
runs-on: ubuntu-latest

container: kivy/buildozer:latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Set ownership of the checkout directory
    run: |
      sudo chown -R kivy:kivy .
  
  # --- CRITICAL FIX: Manually install the required Android build-tools ---
  - name: Manually install Android build-tools 34.0.0
    run: |
      # The sdkmanager is the official command-line tool to manage Android SDK components.
      # This command is a direct order to install version 34.0.0 of the build-tools.
      # The 'yes |' part automatically accepts the license agreement.
      yes | sdkmanager "build-tools;34.0.0"
  # --- END OF FIX ---

  - name: Build the APK with Buildozer
    # Now, when buildozer runs, the build-tools folder will already exist.
    run: |
      buildozer -v android debug

  - name: Upload the APK as a workflow artifact
    uses: actions/upload-artifact@v4
    with:
      name: package-apk
      path: bin/*.apk
